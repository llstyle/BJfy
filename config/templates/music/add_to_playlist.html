{% extends 'base.html' %}

{% block title %}Добавить в плейлист - Music Streaming{% endblock %}

{% block content %}
<h1 class="section-header">Добавить трек в плейлист</h1>

<section class="section" style="max-width: 560px;">
    <div style="margin-bottom: 16px;">
        <div style="font-weight: 700;">{{ song.title }}</div>
        <div style="color: #b3b3b3;">{{ song.artist.name }}</div>
    </div>

    {% if playlists %}
    <form id="addForm">
        {% csrf_token %}
        <div style="margin-bottom: 16px;">
            {% for playlist in playlists %}
            <label style="display:flex; align-items:center; gap:12px; margin-bottom:8px; cursor:pointer;">
                <input type="radio" name="playlist_id" value="{{ playlist.pk }}" {% if forloop.first %}checked{% endif %}>
                <div>
                    <div style="font-weight:600;">{{ playlist.name }}</div>
                    <div style="color:#b3b3b3; font-size:13px;">{{ playlist.songs.count }} треков</div>
                </div>
            </label>
            {% endfor %}
        </div>

        <div style="display:flex; gap:12px;">
            <button type="submit" class="btn btn-primary">Добавить</button>
            <a href="{% url 'home' %}" class="btn btn-secondary">Отмена</a>
        </div>
    </form>
    {% else %}
    <p style="color:#b3b3b3;">У вас пока нет плейлистов. Создайте один в разделе «Мои плейлисты».</p>
    {% endif %}
</section>

<script>
document.getElementById('addForm')?.addEventListener('submit', function(e) {
    e.preventDefault();
    const form = e.currentTarget;
    const data = new URLSearchParams(new FormData(form));
    fetch(window.location.pathname, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: data
    })
    .then(res => res.json())
    .then(json => {
        if (json.status === 'success') {
            // After successful add, go to the playlist detail page (first selected)
            const playlistId = data.get('playlist_id');
            if (playlistId) {
                window.location.href = `/playlist/${playlistId}/`;
            } else {
                window.location.href = '/playlists/';
            }
        }
    })
    .catch(err => console.error('Add to playlist failed', err));
});
</script>

{% endblock %}
