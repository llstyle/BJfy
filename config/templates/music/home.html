{% extends 'base.html' %}

{% block title %}Главная - Music Streaming{% endblock %}

{% block content %}
{% if user.is_authenticated and recommended_songs %}
<section class="section">
    <h2 class="section-header"><i class="mdi mdi-lightbulb-on-outline" style="margin-right: 8px; color: #1db954;"></i>Рекомендации для вас</h2>
    <div class="grid">
        {% for song in recommended_songs %}
    <div class="card song-card" data-song-id="{{ song.pk }}" data-audio="{{ song.get_stream_url }}" data-title="{{ song.title }}" data-artist="{{ song.artist.name }}" data-cover="{{ song.get_cover }}" onclick="playFromCard(this)">
            <div class="play-circle"><i class="mdi mdi-play"></i></div>
            <img src="{{ song.get_cover }}" 
                 alt="{{ song.title }}" class="card-image">
            <div class="card-title">{{ song.title }}</div>
            <div class="card-subtitle">{{ song.artist.name }}</div>
            <div class="card-controls">
                {% if song.pk in favorite_ids %}
                <button class="icon-btn favorited" onclick="event.stopPropagation(); toggleFavorite('{{ song.pk }}')" aria-label="Уже в лайках"><i class="mdi mdi-heart"></i></button>
                {% else %}
                <button class="icon-btn" onclick="event.stopPropagation(); toggleFavorite('{{ song.pk }}')" aria-label="Понравилось"><i class="mdi mdi-heart-outline"></i></button>
                {% endif %}
                <button class="icon-btn menu-btn" onclick="event.stopPropagation(); openMenu(this)" aria-label="Меню">⋮</button>
                <div class="menu-dropdown">
                    <a href="{% url 'add_to_playlist' song.pk %}">Добавить в плейлист</a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</section>
{% endif %}

<section class="section">
    <h2 class="section-header">Новинки</h2>
    <div class="grid">
        {% for song in recent_songs %}
    <div class="card song-card" data-song-id="{{ song.pk }}" data-audio="{{ song.get_stream_url }}" data-title="{{ song.title }}" data-artist="{{ song.artist.name }}" data-cover="{{ song.get_cover }}" onclick="playFromCard(this)">
            <div class="play-circle"><i class="mdi mdi-play"></i></div>
            <img src="{{ song.get_cover }}" 
                 alt="{{ song.title }}" class="card-image">
            <div class="card-title">{{ song.title }}</div>
            <div class="card-subtitle">{{ song.artist.name }}</div>
            {% if user.is_authenticated %}
            <div class="card-controls">
                {% if song.pk in favorite_ids %}
                <button class="icon-btn favorited" onclick="event.stopPropagation(); toggleFavorite('{{ song.pk }}')" aria-label="Уже в лайках"><i class="mdi mdi-heart"></i></button>
                {% else %}
                <button class="icon-btn" onclick="event.stopPropagation(); toggleFavorite('{{ song.pk }}')" aria-label="Понравилось"><i class="mdi mdi-heart-outline"></i></button>
                {% endif %}
                <button class="icon-btn menu-btn" onclick="event.stopPropagation(); openMenu(this)" aria-label="Меню">⋮</button>
                <div class="menu-dropdown">
                    <a href="{% url 'add_to_playlist' song.pk %}">Добавить в плейлист</a>
                </div>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</section>

<section class="section">
    <h2 class="section-header">Популярное</h2>
    <div class="grid">
        {% for song in popular_songs %}
    <div class="card song-card" data-song-id="{{ song.pk }}" data-audio="{{ song.get_stream_url }}" data-title="{{ song.title }}" data-artist="{{ song.artist.name }}" data-cover="{{ song.get_cover }}" onclick="playFromCard(this)">
            <div class="play-circle"><i class="mdi mdi-play"></i></div>
            <img src="{{ song.get_cover }}" 
                 alt="{{ song.title }}" class="card-image">
            <div class="card-title">{{ song.title }}</div>
            <div class="card-subtitle">{{ song.artist.name }}</div>
            {% if user.is_authenticated %}
            <div class="card-controls">
                {% if song.pk in favorite_ids %}
                <button class="icon-btn favorited" onclick="event.stopPropagation(); toggleFavorite('{{ song.pk }}')" aria-label="Уже в лайках"><i class="mdi mdi-heart"></i></button>
                {% else %}
                <button class="icon-btn" onclick="event.stopPropagation(); toggleFavorite('{{ song.pk }}')" aria-label="Понравилось"><i class="mdi mdi-heart-outline"></i></button>
                {% endif %}
                <button class="icon-btn menu-btn" onclick="event.stopPropagation(); openMenu(this)" aria-label="Меню">⋮</button>
                <div class="menu-dropdown">
                    <a href="{% url 'add_to_playlist' song.pk %}">Добавить в плейлист</a>
                </div>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</section>

{% if user.is_authenticated and recommended_artists %}
<section class="section">
    <h2 class="section-header"><i class="mdi mdi-account-music-outline" style="margin-right: 8px; color: #1db954;"></i>Похожие исполнители</h2>
    <div class="grid">
        {% for artist in recommended_artists %}
        <a href="{% url 'artist_detail' artist.pk %}" class="card" style="text-decoration: none; color: inherit;">
            <img src="{% if artist.image %}{{ artist.image.url }}{% else %}/static/placeholder.png{% endif %}" 
                 alt="{{ artist.name }}" class="card-image" style="border-radius: 50%;">
            <div class="card-title">{{ artist.name }}</div>
            <div class="card-subtitle">Исполнитель</div>
        </a>
        {% endfor %}
    </div>
</section>
{% endif %}

{% if user.is_authenticated and recommended_albums %}
<section class="section">
    <h2 class="section-header"><i class="mdi mdi-album" style="margin-right: 8px; color: #1db954;"></i>Рекомендованные альбомы</h2>
    <div class="grid">
        {% for album in recommended_albums %}
        <a href="{% url 'album_detail' album.pk %}" class="card" style="text-decoration: none; color: inherit;">
            <img src="{% if album.cover %}{{ album.cover.url }}{% else %}/static/placeholder.png{% endif %}" 
                 alt="{{ album.title }}" class="card-image">
            <div class="card-title">{{ album.title }}</div>
            <div class="card-subtitle">{{ album.artist.name }}</div>
        </a>
        {% endfor %}
    </div>
</section>
{% endif %}

<section class="section">
    <h2 class="section-header">Исполнители</h2>
    <div class="grid">
        {% for artist in artists %}
        <a href="{% url 'artist_detail' artist.pk %}" class="card" style="text-decoration: none; color: inherit;">
            <img src="{% if artist.image %}{{ artist.image.url }}{% else %}/static/placeholder.png{% endif %}" 
                 alt="{{ artist.name }}" class="card-image" style="border-radius: 50%;">
            <div class="card-title">{{ artist.name }}</div>
            <div class="card-subtitle">Исполнитель</div>
        </a>
        {% endfor %}
    </div>
</section>
{% endblock %}